# Исправления системы конвертации валют в Chicken Road

## Проблема
Система конвертации валют работала неправильно - баланс, передаваемый через URL, обрабатывался как USD, хотя должен был обрабатываться как национальная валюта.

## Исправления

### 1. Исправлена логика входа в игру (main.tpl.php)

**Было:**
```php
$new_balance_local = floatval($_GET['balance']); // Баланс в местной валюте
// Конвертируем баланс из долларов в национальную валюту
$new_balance_national = convertFromUSD($new_balance_local, $user_country);
```

**Стало:**
```php
$new_balance_national = floatval($_GET['balance']); // Баланс в национальной валюте
// Конвертируем баланс из национальной валюты в доллары для отображения в игре
$user_balance_usd = convertToUSD($new_balance_national, $user_country);
```

### 2. Улучшена обработка выхода из игры

Добавлены обработчики для:
- `beforeunload` - автоматическое сохранение при закрытии вкладки
- `message` с типом `closeGame` - сохранение при программном закрытии
- Принудительное сохранение баланса в базе данных перед отправкой родительскому окну

### 3. Исправлена точность конвертации

Добавлено форматирование чисел с фиксированной точностью для избежания ошибок округления.

## Как работает система

### При входе в игру:
1. Получаем баланс в национальной валюте из URL параметра `balance`
2. Конвертируем в USD для отображения в игре: `convertToUSD(balance, country)`
3. Сохраняем национальную валюту в основной базе данных
4. Отображаем USD в интерфейсе игры

### Во время игры:
1. Все расчеты ведутся в USD
2. При каждом изменении баланса конвертируем USD → национальная валюта
3. Сохраняем в основной базе данных в национальной валюте
4. Продолжаем показывать USD в игре

### При выходе из игры:
1. Получаем текущий баланс в USD из игры
2. Конвертируем в национальную валюту: `USD * currency_rate`
3. Сохраняем в базе данных
4. Отправляем родительскому окну баланс в национальной валюте

## Тестирование

Запустите `/chicken-road/test_currency.php` для проверки работы системы конвертации.

## Курсы валют

Курсы настроены в файле `currency.php`:
- Argentina: 1 USD = 1400 ARS
- Colombia: 1 USD = 4500 COP  
- Mexico: 1 USD = 18 MXN
- Brazil: 1 USD = 5 BRL
- И другие...

## Статус
✅ Система исправлена и готова к использованию
✅ Конвертация работает корректно в обе стороны
✅ Баланс сохраняется в правильной валюте
✅ Совместимость с Aviator системой
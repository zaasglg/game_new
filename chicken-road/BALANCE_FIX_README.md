# Исправление сохранения баланса в Chicken Road

## Проблема
Баланс пользователя не сохранялся в базе данных после перезагрузки страницы в игре Chicken Road.

## Исправления

### 1. Обновлен класс Users.class.php
- Добавлены методы для правильной конвертации валют
- Исправлен метод `save_game_result()` для сохранения результатов игры
- Добавлены методы `updateBalance()` и `get_user_balance()`

### 2. Обновлен JavaScript файл game.js
- Исправлены пути к API (добавлен префикс `/chicken-road/`)
- Улучшены методы `saveGameResult()` и `updateBalance()`
- Добавлена правильная синхронизация баланса между игрой и базой данных

### 3. Обновлен JavaScript файл game2.js
- Добавлены вызовы функций сохранения в методы `start()` и `finish()`
- Интегрирована система сохранения результатов игры

### 4. Обновлен шаблон main.tpl.php
- Добавлена логика конвертации валют
- Улучшена система переопределения методов игры
- Добавлены функции для сохранения ставок и результатов

## Как это работает

### Демо режим
- Баланс остается локальным (500 USD)
- Не сохраняется в базе данных
- URL: `/chicken-road/?user_id=demo`

### Реальный режим
- Баланс сохраняется в основной базе данных `volurgame`
- Конвертируется из USD (игра) в национальную валюту (база данных)
- URL: `/chicken-road/?user_id=123&balance=150`

## Система конвертации валют

Игра показывает баланс в USD, но сохраняет в национальной валюте:

```php
// Конвертация из USD в национальную валюту для сохранения
$balance_national = convertFromUSD($balance_usd, $country);

// Конвертация из национальной валюты в USD для отображения
$balance_usd = convertToUSD($balance_national, $country);
```

## API Endpoints

- `POST /chicken-road/api/users/save_game_result` - Сохранение результата игры
- `POST /chicken-road/api/users/update_balance` - Обновление баланса
- `POST /chicken-road/api/users/get_user_balance` - Получение баланса

## Тестирование

1. **PHP API**: `/chicken-road/test_api.php`
2. **JavaScript API**: `/chicken-road/test_js.html`
3. **Отладка баланса**: `/chicken-road/debug_balance.php?user_id=123&balance=150`

## Файлы, которые были изменены

1. `/chicken-road/classes/Users.class.php` - Основная логика сохранения
2. `/chicken-road/res/js/game.js` - JavaScript для сохранения (если используется)
3. `/chicken-road/res/js/game2.js` - Основной JavaScript файл игры
4. `/chicken-road/templates/main.tpl.php` - Шаблон с логикой конвертации
5. `/chicken-road/currency.php` - Функции конвертации валют

## Важные моменты

1. **Конвертация валют**: Игра работает в USD, но сохраняет в национальной валюте
2. **Синхронизация**: Баланс синхронизируется между локальной и основной базами данных
3. **Режимы**: Демо режим не сохраняет данные, реальный режим сохраняет все
4. **API пути**: Все API запросы должны использовать префикс `/chicken-road/`

## Проверка работы

После внесения изменений:

1. Откройте игру в реальном режиме: `/chicken-road/?user_id=123&balance=100`
2. Сделайте ставку и сыграйте
3. Перезагрузите страницу
4. Баланс должен сохраниться и отобразиться правильно

Если проблемы остаются, проверьте:
- Подключение к базе данных `volurgame`
- Правильность user_id в URL
- Логи ошибок в консоли браузера
- Ответы API в Network tab браузера